# Sensorless Field Oriented Control Observer 
## Overview
From a high level, field-oriented control is trying to orient the magnetic field produced by the stator to a particular vector (typically, +- 90 degrees or pi/2 rad to maximize torque production) relative to the rotational frame of the rotor (see the background FOC theory document for more information). To do this, we have to know the rotor's current electrical angle to know where to apply the current. 

Note that the term 'sensorless' does not imply a lack of any sensing or a fully feedforward control system in this context but rather refers to the lack of a position sensor on the rotor of a motor. Self-sensing is another term used in some papers, but (in the resources I came across) sensorless seems to be the common phraseology. 

The explanations here are my understanding and may not be correct given my relative lack of knowledge on PMSM dynamics - corrections are always welcome, and please don't take this explanation at face value :)

### Motivation
In various BLDC/PMSM motor applications, the angle of the rotor (and, by extension, the rotor's electrical angle by considering the number of pole pairs) is determined by employing an external sensor. However, in applications where the standstill operation is not a normal design condition, it may be an attractive choice to consider a sensorless control algorithm for the number of components. Further, sensorless algorithms can improve redundancy in applications where a failed rotor can have grave consequences (such as a motor for an aircraft) by providing an alternative way of commutating the motor without using an external sensor.

## Observers
The control problem considered for sensorless FOC is one where the alpha-beta frame currents, $i_{ab}$ (3 phase currents Clake transformed) and alpha-beta frame voltages $V_{ab}$ (feedforward applied phase voltages that are further Clarke transformed) are known. We want to reconstruct the electrical angle $\theta$ for use in a field-oriented control algorithm. A diagram of the differences between a typical sensored FOC implementation and sensorless FOC implementation is shown below that describes the control problem:
![Typical Sensored FOC](https://github.com/sahil-kale/basilisk-actuator-control-lib/blob/main/assets/typicalfoc.png)

![Typical Sensorless FOC](https://github.com/sahil-kale/basilisk-actuator-control-lib/blob/main/assets/sensorless/typical_sensorless_foc.png)

For the observers to work, the parameters of the motor are also required to be known, such as the phase resistance and inductance, as well as permanent magnet flux linkage. 

### Types of observers 
In my research, I frequently came across 3 types of observers. I'll admit that these concepts have not intuitively clicked for me, but I will include them here alongside a brief overview of my understanding of these terms.

Sliding Mode Observers attempt to reconstruct the back electromotive force of the motor (when the motor acts like a generator). The back EMF generated by the motor is proportional to the speed of the rotor and can be used to predict position by determining the back EMF of the rotor in the alpha-beta frame and then taking the tan-inverse. This method requires the rotor to be at speed before an accurate position measurement can be generated, as back EMF is proportional to the speed. 

Flux observers work by observing the amount of flux generated by the rotor in its phase windings and using this estimate to inform the position of the rotor further. In the first implementation for a flux observer, the paper compared the predicted motor flux to the actual permanent magnet flux value. It used an observer to correct for those terms. Another paper (https://s3.amazonaws.com/scolton-www/motordrive/sensorless_gen1_Rev1.pdf) suggests using the flux zero crossings in a similar fashion to BLDC zero crossing detection.

High-frequency injection methods work by injecting a high-frequency voltage into the stator (the high frequency is to minimize actually moving the rotor) and then measuring the high-frequency current. VESC (https://github.com/vedderb/bldc) is known for having gotten a HFI implementation working. 

A note that BLDC motors can be sensorlessly controlled via trapezoidal commutation by means of zero-crossing detection with the back EMF of the motor. However, this method cannot be used when attempting to employ FOC commutation as this method requires an undriven phase to sense the back EMF voltage of the motor. However, this method is computationally cheap and can result in an effective way to commutate a motor easily.

## Chosen Observer (Flux Observer, Ortega 2010)
I implemented an observer based on a paper (https://cas.mines-paristech.fr/~praly/Telechargement/Journaux/2010-IEEE_TPEL-Lee-Hong-Nam-Ortega-Praly-Astolfi.pdf) published that develops a flux observer based off the phase resistance, inductance, permanent magnet flux, as well as the applied voltages and measured current. Here is my understanding of the paper for my own notes that essentially repeats their section 1 for my own understanding. I reference the paper's equations and state variables here as well as in the code. Note that stator resistance and inductance is 1.5x the phase resistance and currents. A model of a PMSM from (https://www.mathworks.com/help/sps/ref/hybridexcitationpmsm.html) is shown for convenience below:
![PMSM Electrical Model](https://github.com/sahil-kale/basilisk-actuator-control-lib/blob/main/assets/pmsmmodel.png)

First, we determine the flux driving voltage (y), which is the applied alpha-beta voltages (fed-forward) minus the voltage across the stator's resistance (stator resistance multiplied alpha-beta currents - the voltage across the resistance of the stator does not contribute to generating flux). This yields the flux driving voltages in the alpha-beta frame. Importantly, all of the variables in this function are available for measurement or are known quantities. 

```math
\begin{equation}
\begin{bmatrix}
y_\alpha \\
y_\beta 
\end{bmatrix}
=
\begin{bmatrix}
v_\alpha \\
v_\beta 
\end{bmatrix}
-
R_s
\begin{bmatrix}
i_\alpha \\
i_\beta 
\end{bmatrix}
\end{equation}
```

The paper suggests a new state variable, x (which is the total flux of the respective frame, both stator induced as well as the rotor flux linkage), which is the integral of the flux-driving voltage. 

```math
\begin{equation}
\mathbf{x} =
\begin{bmatrix}
x_{\alpha} \\
x_{\beta}
\end{bmatrix}
=
L_s
\begin{bmatrix}
i_{\alpha} \\
i_{\beta}
\end{bmatrix}
+
\psi_m
\begin{bmatrix}
\cos \theta \\
\sin \theta
\end{bmatrix}
\end{equation}
```

Importantly, the paper highlights that $\dot{x} = y$ - therefore, we can estimate x by integrating y.

A vector function defined to be the frame's rotor flux $\eta$ (for both alpha and beta) is determined by subtracting the stator-induced flux (which is the frame current multiplied by the inductance) from the total flux (x). 

```math
\begin{bmatrix}
\eta_{\alpha}(x_{\alpha}) \\
\eta_{\beta}(x_{\beta})
\end{bmatrix}
=
\begin{bmatrix}
x_{\alpha} \\
x_{\beta}
\end{bmatrix}
-
L_s
\begin{bmatrix}
i_{\alpha} \\
i_{\beta}
\end{bmatrix}
=
\psi_m
\begin{bmatrix}
\cos \theta \\
\sin \theta
\end{bmatrix}
```

We recognize that if we take the norm of this 2d $\eta$ vector, which has the rotor flux in both the alpha and beta frame, we'll actually get the permanent magnet flux (squared). 

```math
\|\eta(\mathbf{x})\|^2 = \eta(x_{\alpha})^2 + \eta(x_{\beta})^2 = \psi_m^2$
```

I drew out a figure of the vectors in a particular motor situation and how this would look in the vector frame below:

![Motor Flux Observer Vectors](https://github.com/sahil-kale/basilisk-actuator-control-lib/blob/main/assets/sensorless/sensorless_flux_observer_diagram.png)

The paper in which the observer is defined (https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=ffaf8e3ad8cbfe675b57ba9e01729baf9e2043df, which is used in reference 4) defines an observer in the form of a gradient-search by making an observer that tries to minimize the error between the permanent magnet flux and the predicted flux. This term features an observer gain, gamma, that is meant to be tuned for the observer. The observer state variable, $\dot{\hat{x}}$, attempts to predict the change total flux in each alpha-beta frame. This can then be integrated to find estimates for the total flux in each frame alpha-beta. 

```math
\begin{equation}
\begin{bmatrix}
\dot{\hat{x}}_{\alpha} \\
\dot{\hat{x}}_{\beta}
\end{bmatrix}
=
\begin{bmatrix}
y_{\alpha} \\
y_{\beta}
\end{bmatrix}
+ \frac{\gamma}{2} \left[
\begin{bmatrix}
\eta(\hat{x}_{\alpha}) \\
\eta(\hat{x}_{\beta})
\end{bmatrix} \left( \psi_m^2 - \left\|
\begin{bmatrix}
\eta(\hat{x}_{\alpha}) \\
\eta(\hat{x}_{\beta})
\end{bmatrix}
\right\|^2 \right)
\right]
\end{equation}
```

From the definition of x, we see that theta can be inferred by re-arranging the definition of x to find a matrix definition of cos theta and sin theta, and dividing those 2 equations to equal tan theta, and then re-arranging to determine theta.

```math
\frac{1}{\psi}
\begin{bmatrix}
\hat{x}_{\alpha} - L i_{\alpha} \\
\hat{x}_{\beta} - L i_{\beta}
\end{bmatrix}
=
\begin{bmatrix}
\cos \hat{\theta} \\
\sin \hat{\theta}
\end{bmatrix}
```
```math
\frac{\hat{x}_{\alpha} - L i_{\alpha}}{\hat{x}_{\beta} - L i_{\beta}} = \tan(\hat{\theta})
```
```math
\hat{\theta} = \tan^{-1}\left(\frac{\hat{x}_{\alpha} - L i_{\alpha}}{\hat{x}_{\beta} - L i_{\beta}}\right)
```

### Other Misc Notes
This paper assumes that there is no saliency in the rotor as it means the inductance is not a function of theta. This makes it ideal for surface mount PMSM's, but it seems like interior PMSM's might suffer from inaccurate estimation given this. 

The paper also notes that they did not use an open-loop start-up sequence and found that while they revered the speed, they suffered large amount of angle error as the observer did not converge. Speed buildup meant the angle error vanishes. For the implementation of sensorless control in this library, an open-loop control period will be defined to avoid the potentially harmful impact of oscillating rotor angle estimates whenever the speed is low. Further, the sensorless estimator will self-report itself as being invalid as the rotor speed goes below a preset value, alerting the control loop to no longer trust the theta estimate and either resorting to open loop control or throwing an error accordingly. 

The speed controller is also implemented in their suggested manner with a PI loop to do the integration as they advise against simply differentiating theta.

#### Other Lessons
Initially, when I had implemented sensorless FOC, I noticed that the theta from the flux observer was always phase-shifted at 90 degrees. Turns out I happened to be implementing the PWM generation schema incorrectly and was not actually producing the Valpha/Vbeta I wanted - these inputs are used as feedforward for the estimator and setting those incorrectly meant that the estimator logic was acting on incorrect input.

When initially trialling closed-loop control with the sensorless FOC algorithm, it was observed that if ValphaBeta is varying significantly or oscillates due to a high bandwidth current controller, the estimator would report an incorrect theta and start chattering between 0 and 2pi. Reducing the bandwidth of the current controller fixed the issue - I don't know if I should expect this result with sensorless FOC, but it is there. 

My handling of the open->closed loop control seems off (generates a huge current diff) - best re-thought out and ensure I am actually doing what I expect. What worked awesome was by relying on sensorless FOC once the system was at speed - barely any rotor acceleration after the switchover events and it tracked absolutely awesome!! 

## Open Questions
I don't know in what situations which observer between SMO or Flux is better. I chose to implement the flux observer because I found the paper to be an easier read, but I am not sure which one is better. From 3) in the references section, the author claims that because "the rotor flux linkage is not a function of motor speed. The signal level remains constant at all speeds. Although they are mathematically related by just an integral transformation, the practical implication is that the flux observer can operate at lower speeds than a back EMF observer." This does make sense from the explanation, but I don't intuitively understand this concept just yet.


## References
1) https://imperix.com/doc/implementation/sensorless-motor-control
2) https://www.nxp.com/docs/en/reference-manual/DRM099.pdf
3) https://s3.amazonaws.com/scolton-www/motordrive/sensorless_gen1_Rev1.pdf
4) https://cas.mines-paristech.fr/~praly/Telechargement/Journaux/2010-IEEE_TPEL-Lee-Hong-Nam-Ortega-Praly-Astolfi.pdf
5) https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=ffaf8e3ad8cbfe675b57ba9e01729baf9e2043df
